name: IP Scanner CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio aiohttp

      - name: Run tests
        run: |
          pytest test_scanner.py -v --tb=short

      - name: Run linter
        run: |
          pip install flake8
          flake8 ip_scanner.py --max-line-length=100 --ignore=E501

  nmap-test:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install nmap
        run: |
          sudo apt-get update
          sudo apt-get install -y nmap

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio aiohttp

      - name: Test nmap integration
        run: |
          python -c "
          from ip_scanner import nmap_available, run_nmap_scan
          assert nmap_available(), 'nmap should be installed'
          result = run_nmap_scan('127.0.0.1', ports='22,80', arguments='-sV')
          print('nmap test passed')
          print(result)
          "

  security-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security check with bandit
        run: |
          pip install bandit
          bandit -r ip_scanner.py -f txt -o security_report.txt || true
          cat security_report.txt

  validate-output:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Test output format
        run: |
          python -c "
          import json
          from ip_scanner import parse_ip_range, format_output, OutputFormat, ScanResult, ScanStatus
          
          # Create test results
          results = [
              ScanResult(ip='192.168.1.1', status=ScanStatus.ONLINE, hostname='test.local'),
              ScanResult(ip='192.168.1.2', status=ScanStatus.OFFLINE),
          ]
          
          # Test JSON output
          output = format_output(results, OutputFormat.JSON)
          data = json.loads(output)
          
          # Verify IP as key
          assert '192.168.1.1' in data, 'IP should be key'
          assert '192.168.1.2' in data, 'IP should be key'
          assert data['192.168.1.1']['hostname'] == 'test.local'
          assert data['192.168.1.2']['status'] == 'offline'
          
          print('Output format validation passed!')
          print(json.dumps(data, indent=2))
          "

      - name: Test IP parsing
        run: |
          python -c "
          from ip_scanner import parse_ip_range
          
          # Test CIDR
          ips = parse_ip_range('192.168.1.0/30')
          assert len(ips) == 4, f'Expected 4 IPs, got {len(ips)}'
          
          # Test range
          ips = parse_ip_range('192.168.1.1-5')
          assert len(ips) == 5, f'Expected 5 IPs, got {len(ips)}'
          
          # Test single IP
          ips = parse_ip_range('192.168.1.100')
          assert ips == ['192.168.1.100']
          
          print('IP parsing tests passed!')
          "
